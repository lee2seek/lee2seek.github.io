---
title: Refactor-improving the Design of Existing Code
categories:
  - 读书笔记
tags:
  - 技术
date: 2018-06-23 15:18:53
copyright:
top:
type:
---

## 前言

Refactor-improving the Design of Existing Code(重构-改善既有代码的设计),这是Martin Fowler的一本书.主要是针对Java语言.书已经出版多年了,买这本书也有一年多了,但是一直只看了第一章.最近因为工作不是很忙,就拾起来读了.这里主要是记录下读这本书的一些感想以及收获.
读这本书有个收获,重构不单单只是修改函数名称,重命名变量名称那么简单.比如进行类的分解,将合适的函数放置在合适的类中.而这些都需要我们在平常的编程活动中去实践.
什么时候进行重构呢?当遇到几个方面时,可以考虑进行重构.发现当为函数添加新功能时,并不能很好的添加进去,这时候我们可以进行重构;当写完功能时,我们也可以考虑重构.总之,重构并不是开发过程中必须要通过的一个过程,就像编译-链接等.你可以随时进行重构.

## 重构

我们在平时编程的时候,不可能一次性的就把问题或者程序写的完美无缺,除非我们已经非常熟知某个问题或者某个领域,即使非常熟悉,可能还有我们没有发现的提升之处.那么当我们的程序写的不完美的时候,我们怎么办呢?这时候就可以采用重构的方法来小步快跑的提升我们程序的易读性,优化程序的结构.而这本书给我们提供了如何进行重构的一系列方法.
整个开发流程:
开发---> 测试 ---> 重构 ---> 测试

### 测试

在我们重构之前,一定要有合适的测试.在Java中,我们经常用的就是Junit和TestNG了.其中Junit主要是用来做单元测试,而TestNG主要是功能测试或者集成测试.如果我们是开发人员,可能使用Junit比较多,不过TestNG一般也会用到.在我们重构完成之后,一定要跑测试用例,跑通了所有的测试用例,这项重构才算是完成.

### 代码的坏味道

1. 重复代码
    遇到相同的程序结构,应该想办法将它们合二为一,这样程序会变得更好
2. 过长函数
  函数的代码行数不宜过长,并且函数的命名应该体现出函数做了什么而不是表明怎么做
3. 过大的类
  当类过大时,我们可以采取Extract class 或者Extract Subclass来减小类的大小
4. 过长的参数列
  将函数的参数可以用对象来进行传递
5. 发散式变化
  如果某个类经常因为不同的原因在不同的方向上发生变化,那么这个类就产生了发散式变化.理想情况是针对外界的某一个变化产生的所有相应修改,都应该发生在单一类中.采用 **Extract Class**将因为特定原因造成的所有变化提炼到另一个类中
6. 霰弹式修改
  如果遇到某种变化,都必须在许多不同的类内做出许多小修改,那么就产生了霰弹式修改.遇到这种情况,应该使用**Move Method**和**Move Field**将所有的修改集中在一个类中.
  发散式修改是指"一个类受多种变化的影响",而霰弹式修改是指"一种变化引发多个类的相应修改".理想情况是外界变化与需要修改的类趋于一一对应.
7. 依恋情结
  函数对某个类的兴趣高过对自己所处类的兴趣.这时候我们应该将此函数移动到此函数对应的类中.
8. 数据泥团
  两个类中相同的字段,许多函数签名中相同的参数.这些总是绑定在一起出现的数据应该拥有属于它们的对象
9. 基本类型偏执
  我们有时候可以用对象来替代基本类型,比如当表示由一个起始值和一个结束值组成的range类,一个币种的money类.我们可以创建对应的小对象.
10. switch惊悚现身
  在面向对象程序中尽量少用switch语句,因为switch容易造成重复.而且修改switch条件时,需要找到所有的switch来进行修改
11. 平行继承体系
12. 冗余类
  消除没有用的类
13. 夸夸其谈未来性
14. 令人迷惑的暂时字段
15. 过度耦合的消息链
16. 中间人
  不要过度使用委托
17. 狎昵关系
18. 异曲同工的类
19. 不完美的类库
20. 过多的注释

### 重构方法

> 这里仅仅记录了部分的重构方法

1. 提取方法
  在重构中有一个很核心的动作就是将代码提取为一个单独的方法.这种方式其实也杜绝了重复代码的出现,能够在我们修改代码的时候只需要修改一处就可以.并且能够在多个地方使用
2. 将注释提取为方法
  理想的程序就是代码完全能够表达自己,当我们在程序中看到注释或者添加注释的时候,我们可以先思考下能否将注释下的代码提取为一个方法,并且方法的函数名称能够体现注释的内容,方法名称要体现程序做了什么而不是怎么做.
3. 明确类的职责
  类的职责不宜过于多,不宜过于复杂.如果看到一个类承担的职责很多,我们可以考虑是否可以将此类拆分,将不属于其应该承担的责任提取到一个新的类中.然后在源类中通过引用来使用新类中的字段或方法
4. 用查询来代替变量
  就是在我们使用变量时,我们应该采用计算变量的方法来替代此变量.其实对于这一做法,我是抱有怀疑态度的,因为这造成了函数运行多次.会造成性能下降,但是书中说性能优化属于优化阶段的工作,而且这样重构会为优化阶段带来很好的铺垫.这个我觉得还是主要看平时我们的工作中需要具体情况具体分析.不能尽信书,什么东西都需要我们自己的独立思考
5. 以卫语句取代嵌套条件表达式
  条件表达式的两种形式:1.所有分支都属于正常分支;2.只有一种是正常行为,其他都是不正常行为.针对情况1,建议使用if...else结构;针对情况2,使用if进行判断,然后直接返回结果.这样子处理能够提高程序清晰度
6. 封装集合
  当我们在类中有个字段是集合时,我们的返回函数不应该直接返回集合自身,而是应该返回集合的只读副本.另外,不应该为这整个集合提供一个设值函数,应该提供为集合添加,删除元素的函数.
7. 分解条件表达式
  将复杂的条件表达式分解为较简单的表达式,可是试着尝试将if段落以及else then等提炼为单独的函数
8. 合并条件表达式
  如果发现检查条件各不相同,但是最终的行为一致.应该使用逻辑与和逻辑或合并为一个条件表示式
9. 引入参数对象
  可以使用对象来替换函数中的众多参数.比如,遇到数据范围的,参数是一个开始时间,结束时间,那么可以新建一个日期范围类,其中的开始时间和结束时间不能修改.用此类来替换开始时间和结束时间.这样做的好处是可以缩短参数列表.
10. 移除设置函数
    如果类中的某个字段在对象创建之后不能修改,那么就不提供设置函数,并且将此字段设为**final**